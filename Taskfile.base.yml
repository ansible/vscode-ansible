---
# see https://taskfile.dev/#/
version: "3"
vars:
  GIT_ROOT:
    sh: git rev-parse --show-toplevel
tasks:
  yarn:
    cmds:
      - yarn install --immutable --silent
    dir: "{{ .TASKFILE_DIR }}"
    generates:
      - node_modules/.yarn-state.yml
    sources:
      - package.json
      - packages/*/package.json
      - yarn.lock
    run: once
    interactive: true
  uv:
    cmds:
      - uv sync --no-progress -q --active
      - bash ./tools/uv.sh
    generates:
      - "{{ .VIRTUAL_ENV }}/pyvenv.cfg"
      - "{{ .VIRTUAL_ENV }}/CACHEDIR.TAG"
    dir: "{{ .TASKFILE_DIR }}"
    sources:
      - pyproject.toml
      - uv.lock
      - tools/uv.sh
    run: once
    interactive: true
  setup:
    desc: Setup build toolchain and install missing dependencies
    env:
      # used inside test-setup.sh
      OS: "{{OS}}"
      ARCH: "{{ARCH}}"
    deps:
      - mise
      - yarn
      - uv
    dir: "{{ .TASKFILE_DIR }}"
    cmds:
      - bash ./tools/test-setup.sh
      - ./tools/precheck.sh
    sources:
      - ./tools/precheck.sh
      - pyproject.toml
      - tools/test-setup.sh
    generates:
      - out/log/manifest-*.yml
    run: once
    interactive: true
  mise:
    desc: Check if mise is installed and working
    internal: true
    silent: true
    status:
      - '[ "$SKIP_MISE" == "1" ] || [ "$CI" == "true" ]'
    cmds:
      - "mise --version >>/dev/null || { echo ''ERROR: mise not found in PATH'' >&2; exit 1; }"
      - "mise doctor >>/dev/null || { mise doctor || echo 'ERROR: mise doctor failed, resolve reported problems.' >&2 && exit 1; }"
