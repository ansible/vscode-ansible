---
# see https://taskfile.dev/#/
# cspell: ignore unshallow
version: "3"
includes:
  base:
    taskfile: ./Taskfile.base.yml
    flatten: true
  als:
    taskfile: ./packages/ansible-language-server
    dir: ./packages/ansible-language-server
  mcp:
    taskfile: ./packages/ansible-mcp-server
    dir: ./packages/ansible-mcp-server
output: prefixed # do not use "group" due to impact on CI
env:
  # Overridden by some specific jobs
  CODE_VERSION: max
vars:
  VIRTUAL_ENV:
    sh: echo "${HOME}/.local/share/virtualenvs/vsa"
  XVFB:
    # prefix to add to allow execution of test in headless machines (CI)
    # keep the space after log filename as it is needed.
    sh: bash -c 'if [[ "$OSTYPE" == "linux-gnu"* ]] && command -v xvfb-run >/dev/null; then echo "$(command -v xvfb-run) --auto-servernum -e out/log/xvfb.log "; fi'
tasks:
  default:
    desc: Run most commands
    cmds:
      - task: setup
      - task: lint
      - task: package
      - task: docs
      - echo {{.TASK}}
  version:
    cmds:
      - ./tools/helper --version
  clean:
    desc: Clean up all files that not tracked by git
    cmds:
      - git clean -dxf
  finish:
    desc: Commands to run at the end of build and test processes
    dir: "{{ .TASKFILE_DIR }}"
    cmds:
      # clean up uv cache, important for CI especially for caching size reduction
      - task: ci_clean_cache
      # we also need to be sure that at the end of build and test we do not produce undesired side effects
      - ./tools/precheck.sh
      # ensure that `vitest list` works and does not display any warnings (stderr)
      - vitest list 1>out/log/vitest-list-stdout.txt 2>out/log/vitest-list-stderr.txt && test ! -s out/log/vitest-list-stderr.txt || { echo "Failing because 'vitest list' should not produce any warnings:"; cat out/log/vitest-list-stderr.txt; exit 5; }
      - tools/dirty.sh

  build:
    desc: Build the project
    deps:
      - setup
    cmds:
      - for: sources
        cmd: echo {{ .ITEM }}
      - yarn workspaces foreach --all -tv run clean
      - yarn run build
      - yarn run vite-build
    sources:
      - package.json
      - "{src,test}/**/*"
      - tsconfig*.json
      - webpack.config.ts
      - yarn.lock
      - exclude: "**/.ansible/**/*"
      - exclude: "**/None/**/*"
      - exclude: "src/vscode_ansible.egg-info/**/*"
      - exclude: "test/**/__pycache__/**/*"
      - exclude: "test/selenium/**/*"
      - exclude: "test/testFixtures/.vscode/**/*"
      - exclude: "test/testFixtures/common/collections/ansible_collections/**/*"
      - exclude: "test/testFixtures/hover/with_ee/collections/ansible_collections/**/*"
      - exclude: "test/testFixtures/hover/without_ee/collections/ansible_collections/**/*"
    generates:
      - out/client/**/*
      - out/server/**/*
  code:
    env:
      # https://github.com/microsoft/vscode/issues/82524#issuecomment-1150315756
      NODE_OPTIONS: "--no-deprecation"
    desc: Forced install of extension in your code instance
    cmds:
      - task: package
      - code --force --install-extension *.vsix
  deps:
    desc: Update dependencies
    env:
      VSCODE_VERSION:
        sh: node -p "require('./package.json').engines.vscode"
    cmds:
      - task: "deps:python"
      - task: setup
      # upgrade yarn itself
      - yarn set version latest
      # bumps some developments dependencies
      - task: "deps:node"
      # disabled because it does not work recursively
      # - yarn upgrade-interactive
      # restores a potential update of @types/vscode
      - yarn up "@types/vscode@${VSCODE_VERSION}"
      - yarn dedupe
      # running install after upgrade is needed in order to update the lock file
      - task: shared:install
      - "{{.VIRTUAL_ENV}}/bin/python3 -m pre_commit autoupdate"
      - task: lint
      - task: build
    interactive: true
  "deps:node":
    desc: Update node dependencies
    interactive: true # needed for ncu prompts
    cmds:
      - yarn ncu -u --workspaces -i
      - yarn knip --exclude=exports
  "deps:python":
    desc: Update python dependencies
    cmds:
      - uv sync --upgrade
      # should prevent increasing cache size significantly on CI
      - task: ci_clean_cache
      - "{{.VIRTUAL_ENV}}/bin/python3 -m pre_commit autoupdate"
      - task: lint
      - task: build
  docs:
    dir: "{{ .TASKFILE_DIR }}"
    desc: Build the documentation
    deps:
      - setup
    sources:
      - docs/**/*
      - media/**/*
      - mkdocs.yml
      - packages/ansible-language-server/tools/settings-doc-generator.ts
      - pyproject.toml
    generates:
      - out/html/**/*
    cmds:
      # Retrieve possibly missing commits:
      - $(git rev-parse --is-shallow-repository) && git fetch --unshallow > /dev/null || true
      - git fetch --tags --force
      - npx tsx packages/ansible-language-server/tools/settings-doc-generator.ts
      - bash -c '. "${VIRTUAL_ENV}/bin/activate" && mkdocs build --strict --site-dir=${READTHEDOCS_OUTPUT:-out}/html/'
      - defer: { task: finish }
  lint:
    desc: Lint the project
    interactive: true
    cmds:
      - "{{.VIRTUAL_ENV}}/bin/prek run -a"
      - defer: { task: finish }
    silent: true
    sources:
      - "*.*"
      - .config
      - .github
      - .vscode
      - doc
      - examples
      - images
      - src
      - syntaxes
      - test
      - tools
      - exclude: out
      - exclude: node_modules
      - exclude: site
      - exclude: packages/*/out
      - exclude: .cache

  test:
    # cspell: disable-next-line
    desc: "Run all tests: unit, ui, e2e, als, mcp"
    cmds:
      - task: setup
      # keep test types ordered by their durations, faster tests first
      - task: unit # 10s
      - task: mcp:test # 13s
      - task: als:test # 20s
      - task: e2e # 1min
      - task: ui # 10min
      # .vsix file is no longer needed for executing tests.
      # This is just for making sure that the package step works w/o issues.
      - task: package
      - defer: { task: finish }
    interactive: true
  e2e:
    dir: "{{ .TASKFILE_DIR }}"
    vars:
      TEST_PREFIX: "{{ .TASK }}"
    desc: Run e2e tests with vscode-test {{.XVFB}}
    deps:
      - package
    env:
      NODE_NO_WARNINGS: "1"
      DONT_PROMPT_WSL_INSTALL: "1"
      # Possible workaround for: https://github.com/microsoft/vscode-test-cli/issues/555
      TMP: "{{ .TASKFILE_DIR }}/out/tmp/e2e"
    generates:
      - out/junit/e2e-test-results.xml
      - out/coverage/e2e/cobertura-coverage.xml
      - out/coverage/e2e/lcov.info
      - out/log/e2e/e2e.log
    sources:
      - "{src,test}/**/*"
      - .vscode-test.mjs
      - exclude: "**/.ansible/**/*"
      - exclude: test/testFixtures/.vscode/settings.json
      - exclude: test/testFixtures/diagnostics/yaml/invalid_yaml.yml
      - exclude: test/unit/lightspeed/utils/samples/collections/ansible_collections/community/broken_MANIFEST/MANIFEST.json
    cmds:
      - mkdir -p out/tmp/e2e
      # dry run to fail fast if we misconfigure it
      - "{{.XVFB}}vscode-test --dry-run --fail-zero"
      # cannot put coverage option inside .vscode-test.mjs
      - "{{.XVFB}}vscode-test --install-extensions out/ansible-*.vsix --coverage --coverage-output ./out/coverage/e2e --coverage-reporter text --coverage-reporter cobertura --coverage-reporter lcovonly"
      - defer: { task: collect-logs, vars: { TEST_PREFIX: "{{.TEST_PREFIX}}" } }
    interactive: true
  ui-selenium:
    desc: Run UI tests (Selenium)
    deps:
      - package
    sources:
      - "*.vsix"
      - pyproject.toml
      - test/ui-selenium/**/*
      - uv.lock
    generates:
      - out/junit/ui-selenium-test-results.xml
    cmds:
      # settings.json gets changed during tests so we do copy it
      # we use same location for altered settings.json for all test suites
      - mkdir -p out/test-resources/settings/User/ out/ui-selenium/logs out/ui-selenium/coder-logs
      - cp -f test/testFixtures/settings.json out/test-resources/settings/User/settings.json
      - >
        VSX_FILE=${PWD}/$(ls -1 out/ansible-*.vsix) &&
        podman run
        --pull=missing
        --replace
        --detach
        --rm
        --shm-size=10g
        --name selenium-vscode
        -p 4444:4444
        -p 5999:5999
        --volume $VSX_FILE:/ansible-latest.vsix:ro,Z
        --volume ./out/test-resources/settings/User/settings.json:/home/selenium/.local/share/code-server/User/settings.json:rw,Z
        --volume ${PWD}/out/ui-selenium/logs:/home/selenium/.local/share/code-server/logs:rw,Z
        quay.io/tshinhar/selenium-vscode-multi:latest
      - curl -sS --retry 10 --retry-all-errors http://localhost:4444
      - pytest
      - podman stop selenium-vscode
    interactive: true
  unit:
    desc: Run unit tests with coverage report
    deps:
      - build
    sources:
      - "{src,test}/**/*"
      # - test/**/*
      - vitest.config.ts
      - packages/*/{src,test}/**.*
    generates:
      - out/coverage/unit/lcov.info
      - out/junit/unit-test-results.xml
    cmds:
      - vitest run
    interactive: true
  package:
    desc: Package extension
    deps:
      - build
    sources:
      - "{src,media,webviews}/**/*" # do not include 'test' as they do not get into the package
      - .vscodeignore
      - CHANGELOG.md
      - README.md
      - exclude: "**/.ansible/**/*"
      - exclude: "test/selenium/ui/**/*"
      - package*.json
      - tools/helper
      - yarn.lock
    generates:
      - "out/*.vsix"
      - "out/@ansible-ansible-mcp-server*.tgz"
      - "out/@ansible-ansible-language-server*.tgz"
    cmds:
      # we want to build both all the time:
      - task: als:package
      - task: mcp:package # to produce the tgz file that can-release is using (implies install)
      - ./tools/helper --package
      - packages/ansible-language-server/tools/can-release.sh
      - defer: { task: finish }
    silent: true
  pr:
    desc: Opens a pull request using gh
    deps:
      - setup
    cmds:
      - task: lint
      - gh pr create
    interactive: true
  release:
    desc: Create a new release (used by CI)
    cmds:
      - ./tools/release.sh
    interactive: true
  builder:
    desc: Build container image used for building the extension
    cmds:
      - ./tools/builder.sh
  image-konflux:
    desc: Build container image used for building the extension for Konflux CI
    cmds:
      - podman build --build-arg GITHUB_TOKEN -f vscode-ansible.Containerfile --format=docker
  ci_clean_cache:
    desc: Clean up caches (only runs when CI=true)
    status:
      - '[ "$CI" != "true" ]'
    cmds:
      - uv cache prune --ci
      - find `python3 -m pip cache dir`/wheels -type f -atime +30 -delete || true
  flush:
    desc: Cleans cached files that sometimes can affect the build negatively, not a full clean
    cmds:
      - rm -rf out/test-resources/screenshots/* out/test-resources/settings/logs/* || true
      - rm -rf .vscode-test/ out/test-resources/VSCode-* out/test-resources/"Visual Studio Code.app" || true
      - rm -f out/test-resources/*stable.zip out/test-resources/*.tar.gz || true
  dry:
    desc: Pretend it does run tests, used to validate configuration of the test frameworks
    deps:
      - package
    cmds:
      - vitest list
  collect-logs:
    requires:
      vars: [TEST_PREFIX]
    cmds:
      - mkdir -p out/{{.TEST_PREFIX}}/screenshots
      - |
        find out/test-resources/logs -name "*.log" -type f -exec cp -v {} out/{{.TEST_PREFIX}}/ \; 2>/dev/null || true
        find out/test-resources/settings/logs -type f -exec cp -v {} out/{{.TEST_PREFIX}}/ \; 2>/dev/null || true
        find out/test-resources/screenshots -type f -exec cp -v {} out/{{.TEST_PREFIX}}/screenshots \; 2>/dev/null || true
      - defer: tools/sanitize-logs.py out/{{.TEST_PREFIX}}/*.log
