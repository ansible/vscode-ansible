# Read the Docs configuration file
# See https://docs.readthedocs.io/en/stable/config-file/v2.html
# for details

---

# Required
version: 2

mkdocs:
  fail_on_warning: true
  configuration: mkdocs.yml

# Optionally build your docs in additional formats
# such as PDF and ePub
formats: []

submodules:
  include: all  # []
  exclude: []
  recursive: true

build:
  os: ubuntu-24.04
  tools:
    python: "3.13"
  apt_packages:
    - curl
    - file
    - git
    - git-lfs
    - libgbm-dev
    - libonig-dev
    - libssh-dev
    - python3-pip
    - python3-venv
    - qemu-user-static
    - x11-xserver-utils
    - xvfb
  jobs:
    build:
      html:
        # NODE_OPTIONS must be kept in sync with one inside .env file
        - >
          NODE_OPTIONS=--max-old-space-size=8192
          UV_PROJECT_ENVIRONMENT=$READTHEDOCS_VIRTUALENV_PATH
          PATH=~/.local/bin:$PATH
          CI=1
          ~/.local/bin/mise exec -- task docs
    create_environment:
      - curl https://mise.run | sh
      - ~/.local/bin/mise settings experimental=true
      - ~/.local/bin/mise settings python.compile=false
      - ~/.local/bin/mise settings python.uv_venv_auto=true
      - ~/.local/bin/mise trust
      - ~/.local/bin/mise install -v
      - ~/.local/bin/mise exec -- uv venv "${READTHEDOCS_VIRTUALENV_PATH}"
      - ~/.local/bin/mise exec -- task --version

    install:
      # Custom docs dependencies installation, based on uv.lock
      - >
        VIRTUAL_ENV=$READTHEDOCS_VIRTUALENV_PATH
        UV_CACHE_DIR=$READTHEDOCS_VIRTUALENV_PATH/../../uv_cache
        ~/.local/bin/mise exec -- uv sync --active --locked
    post_checkout:
      # Check out the full depth for setuptools-scm
      - git fetch --unshallow || true
      # Check out git-lfs files
      # See https://docs.readthedocs.io/en/stable/build-customization.html#support-git-lfs-large-file-storage
      - wget
        https://github.com/git-lfs/git-lfs/releases/download/v3.4.0/git-lfs-linux-amd64-v3.4.0.tar.gz
      # cspell: ignore xvfz
      - tar xvfz git-lfs-linux-amd64-v3.4.0.tar.gz
      - ln --symbolic git-lfs-3.4.0/git-lfs git-lfs
      - git config filter.lfs.process "`pwd`/git-lfs filter-process"
      - git config filter.lfs.smudge  "`pwd`/git-lfs smudge -- %f"
      - git config filter.lfs.clean "`pwd`/git-lfs clean -- %f"
      - ./git-lfs install
      - ./git-lfs fetch
      - ./git-lfs checkout
